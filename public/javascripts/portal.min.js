"use strict";function start(a){pc=new RTCPeerConnection(configuration),pc.onicecandidate=function(a){socket.emit("message",{type:"candidate",data:a.candidate})},pc.onaddstream=function(a){comunication(!0),remoteVideo.src=window.URL.createObjectURL(a.stream)},pc.oniceconnectionstatechange=function(){"disconnected"===pc.iceConnectionState&&console.log("Me cambiaron el estado")},navigator.getUserMedia({audio:!0,video:{optional:[{minWidth:"1280"},{minHeight:"720"}],mandatory:{}},iceServers:[{url:"stun:stun.l.google.com:19302"}]},function(b){function c(a){pc.setLocalDescription(a),socket.emit("message",{type:"description",data:a})}localVideo.src=window.URL.createObjectURL(b),pc.addStream(b),window.stream=b,a?pc.createOffer(c,logFail):pc.createAnswer(c,logFail)},logFail)}function switcher(){tracks=window.stream.getTracks(),video=tracks[0],audio=tracks[1],video.enabled&&audio.enabled?socket.emit("quiet"):socket.emit("talk"),tracks.forEach(function(a){a.enabled=!a.enabled})}function logFail(a){console.log(a)}function comunication(a){canvas.style.display=a?"none":"inline",a?stopAnimate():animate(),remoteVideo.style.display=a?"inline":"none",localVideo.style.display=a?"inline":"none"}function stopAnimate(){void 0!==animation&&(clearInterval(animation),animation=void 0)}function animate(){return animation=setInterval(function(){init()},0)}function init(){var a,b=0,c=document.getElementById("canvas"),d=c.getContext("2d");d.canvas.width=window.innerWidth,d.canvas.height=window.innerHeight;var e=c.height,f=c.width,g=200,h=g*(e/f),i=f/g,j=e/h,k=Date.now()/20;if("undefined"==typeof a){a=[];for(var l,m,n,o=0;256>o;o++)l=~~(portal.color.r+.2*Math.sin(Math.PI*o/32)),m=~~(portal.color.g+10*Math.sin(Math.PI*o/64)),n=~~(portal.color.b+10*Math.sin(Math.PI*o/128)),a[o]="rgb("+~~l+","+~~m+","+~~n+")"}for(var p,q=function(a,b,c,d){return Math.sqrt((a-c)*(a-c)+(b-d)*(b-d))},r=function(a,b){return.25*(128+128*Math.sin(.0625*a)+128+128*Math.sin(.03125*b)+128+128*Math.sin(.125*q(a+k,b-k,f,e))+128+128*Math.sin(.125*Math.sqrt(a*a+b*b)))},s=0;h>s;s++)for(p=0;g>p;p++)d.fillStyle=a[~~(r(p,s)+b)%256],d.fillRect(Math.floor(p*i),Math.floor(s*j),Math.ceil(i),Math.ceil(j));b++}var io,socket=io.connect(),pc,configuration=null,localVideo=document.getElementById("localvideo"),remoteVideo=document.getElementById("remotevideo"),canvas=document.getElementById("canvas"),flag=!1,tracks,video,audio,portalparam=window.location.search.split("=")[1],portal,animation,audioOn=document.getElementById("portalOn"),audioOff=document.getElementById("portalOff"),room="portal";socket.on("connect",function(){socket.emit("room",room)});var portales={cuu:{color:{r:255,g:130,b:0},greeting:"hello Chihuahua"},hmo:{color:{r:1,g:80,b:255},greeting:"hello HMO"},cdmx:{color:{r:3,g:40,b:155},greeting:"hello CDMX"},"default":{color:{r:50,g:50,b:55}}};portal=portalparam?portales[portalparam]:portales["default"],socket.on("join",function(a){1===a&&(flag=!0,comunication(!1)),flag===!1&&(comunication(!0),start(!0))}),socket.on("talk",function(a){audioOn.play(),video.enabled=!0,audio.enabled=!0,comunication(!0)}),socket.on("quiet",function(a){tracks=window.stream.getTracks(),video=tracks[0],audio=tracks[1],audioOff.play(),video.enabled=!1,audio.enabled=!1,comunication(!1)}),socket.on("message",function(a){if(pc||start(!1),"description"===a.type)pc.setRemoteDescription(new RTCSessionDescription(a.data));else if("candidate"===a.type&&a.data){var b=new RTCIceCandidate(a.data);pc.addIceCandidate(b,function(a){},logFail)}}),socket.on("redirect",function(){window.location.href="/full"}),socket.on("refresh",function(){window.location.reload()}),$(window).keyup(function(a){82===a.keyCode&&switcher()}),$(document).ready(function(){function a(){$(".remote").height($(window).height())}a(),$(window).resize(function(){a()}),$("#hide-local-preview").click(function(){$(".r-b-corner").toggleClass("hidden")})});