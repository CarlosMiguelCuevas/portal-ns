"use strict";function start(a){pc=new RTCPeerConnection(configuration),pc.onicecandidate=function(a){socket.emit("message",{type:"candidate",data:a.candidate})},pc.onaddstream=function(a){comunication(!0),remoteVideo.src=window.URL.createObjectURL(a.stream)},pc.oniceconnectionstatechange=function(){"disconnected"===pc.iceConnectionState&&console.log("Me cambiaron el estado")},navigator.getUserMedia({audio:!0,video:!0},function(b){function c(a){pc.setLocalDescription(a),socket.emit("message",{type:"description",data:a})}localVideo.src=window.URL.createObjectURL(b),pc.addStream(b),window.stream=b,a?pc.createOffer(c,logFail):pc.createAnswer(c,logFail)},logFail)}function switcher(){window.stream&&(tracks=window.stream.getTracks(),video=tracks[0],audio=tracks[1],video.enabled&&audio.enabled?socket.emit("quiet"):socket.emit("talk"),tracks.forEach(function(a){a.enabled=!a.enabled}))}function logFail(a){console.log(a)}function comunication(a){canvas.style.display=a?"none":"inline",a?stopAnimate():animate(),remoteVideo.style.display=a?"inline":"none",localVideo.style.display=a?"inline":"none"}function stopAnimate(){void 0!==animation&&(clearInterval(animation),animation=void 0)}function animate(){return animation=setInterval(function(){init()},0)}function init(){var a,b=0,c=canvas.getContext("2d");c.canvas.width=window.innerWidth,c.canvas.height=window.innerHeight;var d=canvas.height,e=canvas.width,f=200,g=f*(d/e),h=e/f,i=d/g,j=Date.now()/20;if("undefined"==typeof a){a=[];for(var k,l,m,n=0;256>n;n++)k=~~(portal.color.r+.2*Math.sin(Math.PI*n/32)),l=~~(portal.color.g+10*Math.sin(Math.PI*n/64)),m=~~(portal.color.b+10*Math.sin(Math.PI*n/128)),a[n]="rgb("+~~k+","+~~l+","+~~m+")"}for(var o,p=function(a,b,c,d){return Math.sqrt((a-c)*(a-c)+(b-d)*(b-d))},q=function(a,b){return.25*(128+128*Math.sin(.0625*a)+128+128*Math.sin(.03125*b)+128+128*Math.sin(.125*p(a+j,b-j,e,d))+128+128*Math.sin(.125*Math.sqrt(a*a+b*b)))},r=0;g>r;r++)for(o=0;f>o;o++)c.fillStyle=a[~~(q(o,r)+b)%256],c.fillRect(Math.floor(o*h),Math.floor(r*i),Math.ceil(h),Math.ceil(i))}var io,socket=io.connect(),pc,configuration=null,localVideo=document.getElementById("localvideo"),remoteVideo=document.getElementById("remotevideo"),canvas=document.getElementById("canvas"),flag=!1,tracks,video,audio,portalparam=window.location.search.split("=")[1],portal,animation,audioOn=document.getElementById("portalOn"),audioOff=document.getElementById("portalOff"),room=$("#roomid").data("room");socket.on("connect",function(){socket.emit("room",room)});var portales={cuu:{color:{r:255,g:130,b:0},greeting:"hello Chihuahua"},hmo:{color:{r:1,g:80,b:255},greeting:"hello HMO"},cdmx:{color:{r:3,g:40,b:155},greeting:"hello CDMX"},"default":{color:{r:50,g:50,b:55}}};portal=portalparam?portales[portalparam]:portales["default"],socket.on("join",function(a){1===a&&(flag=!0,comunication(!1)),flag===!1&&(comunication(!0),start(!0))}),socket.on("talk",function(a){audioOn.play(),video.enabled=!0,audio.enabled=!0,comunication(!0)}),socket.on("quiet",function(a){tracks=window.stream.getTracks(),video=tracks[0],audio=tracks[1],audioOff.play(),video.enabled=!1,audio.enabled=!1,comunication(!1)}),socket.on("message",function(a){if(pc||start(!1),"description"===a.type)pc.setRemoteDescription(new RTCSessionDescription(a.data));else if("candidate"===a.type&&a.data){var b=new RTCIceCandidate(a.data);pc.addIceCandidate(b,function(a){},logFail)}}),socket.on("redirect",function(){window.location.href="/full"}),socket.on("refresh",function(){window.location.reload()}),$(window).keyup(function(a){82===a.keyCode&&switcher()}),$(document).ready(function(){function a(){$(".remote").height($(window).height())}a(),$(window).resize(function(){a()}),$("#hide-local-preview").click(function(){$(".r-b-corner").toggleClass("hidden")})});